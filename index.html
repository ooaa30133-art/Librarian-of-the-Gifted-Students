<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#673AB7">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨Ø© Ø¹Ø±Ø¨ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª">
    <title>Ù…ÙƒØªØ¨ØªÙŠ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
/* ============================================
   Ù…ÙƒØªØ¨ØªÙŠ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©
   Ù…Ù„Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø§Ù…Ù„
   ============================================ */

/* ================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ================== */
:root {
    /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    --color-primary: #2563EB;
    --color-primary-dark: #1D4ED8;
    --color-primary-light: #3B82F6;
    --color-secondary: #673AB7;

    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø© */
    --color-success: #10B981;
    --color-success-light: #D1FAE5;
    --color-danger: #EF4444;
    --color-danger-light: #FEE2E2;
    --color-warning: #F59E0B;
    --color-warning-light: #FEF3C7;
    --color-info: #3B82F6;
    --color-info-light: #DBEAFE;

    /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© */
    --color-bg: #F3F4F6;
    --color-bg-dark: #1F2937;
    --color-surface: #FFFFFF;
    --color-border: #E5E7EB;
    --color-text: #1F2937;
    --color-text-muted: #6B7280;
    --color-text-light: #9CA3AF;

    /* Ø§Ù„Ø®Ø·ÙˆØ· */
    --font-main: 'Tajawal', 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

    /* Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;

    /* Ø§Ù„Ø­ÙˆØ§Ù ÙˆØ§Ù„Ø²ÙˆØ§ÙŠØ§ */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-full: 9999px;

    /* Ø§Ù„Ø¸Ù„Ø§Ù„ */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

    /* Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;

    /* ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    --header-height: 60px;
    --nav-height: 70px;
    --safe-area-bottom: env(safe-area-inset-bottom, 0px);
}

/* ================== Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† ================== */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    direction: rtl;
    font-size: 16px;
    scroll-behavior: smooth;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: var(--font-main);
    background-color: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: calc(var(--nav-height) + var(--safe-area-bottom));
}

/* ================== Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ================== */
h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    line-height: 1.3;
    color: var(--color-text);
}

h1 { font-size: 1.75rem; }
h2 { font-size: 1.5rem; }
h3 { font-size: 1.25rem; }
h4 { font-size: 1.125rem; }

a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
}

a:hover {
    color: var(--color-primary-dark);
}

/* ================== Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ================== */
.app-header {
    position: fixed;
    top: 0;
    inset-inline-start: 0;
    inset-inline-end: 0;
    height: var(--header-height);
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white;
    z-index: 100;
    box-shadow: var(--shadow-md);
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 100%;
    padding: 0 var(--spacing-md);
    max-width: 1200px;
    margin: 0 auto;
}

.app-title {
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.menu-toggle {
    display: flex;
    flex-direction: column;
    gap: 4px;
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);
    transition: background var(--transition-fast);
}

.menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
}

.menu-toggle span {
    display: block;
    width: 24px;
    height: 3px;
    background: white;
    border-radius: var(--radius-full);
    transition: var(--transition-fast);
}

/* ================== Ø§Ù„ØªÙ†Ù‚Ù„ ================== */
.main-nav {
    position: fixed;
    bottom: 0;
    inset-inline-start: 0;
    inset-inline-end: 0;
    height: var(--nav-height);
    background: var(--color-surface);
    border-top: 1px solid var(--color-border);
    z-index: 100;
    padding-bottom: var(--safe-area-bottom);
    box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
}

.nav-list {
    display: flex;
    justify-content: space-around;
    align-items: center;
    list-style: none;
    height: 100%;
    max-width: 600px;
    margin: 0 auto;
}

.nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: var(--spacing-sm) var(--spacing-md);
    color: var(--color-text-muted);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    min-width: 60px;
}

.nav-link:hover {
    color: var(--color-primary);
    background: var(--color-info-light);
}

.nav-link.active {
    color: var(--color-primary);
    background: var(--color-info-light);
}

.nav-icon {
    font-size: 1.25rem;
}

/* ================== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ================== */
.main-content {
    padding-top: calc(var(--header-height) + var(--spacing-md));
    padding-inline-end: var(--spacing-md);
    padding-inline-start: var(--spacing-md);
    padding-bottom: calc(var(--nav-height) + var(--spacing-lg));
    max-width: 1200px;
    margin: 0 auto;
}

.section {
    display: none;
    animation: fadeIn var(--transition-normal);
}

.section.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
    gap: var(--spacing-md);
}

.section-header h2 {
    margin: 0;
}

.back-btn {
    display: none;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-family: var(--font-main);
    color: var(--color-text);
    transition: all var(--transition-fast);
}

.back-btn:hover {
    background: var(--color-bg);
}

/* ================== dashboard cards Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ================== */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.dash-card {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-normal);
    animation: fadeUp 0.4s ease-out backwards;
}

.dash-card:nth-child(1) { animation-delay: 0ms; }
.dash-card:nth-child(2) { animation-delay: 100ms; }
.dash-card:nth-child(3) { animation-delay: 200ms; }
.dash-card:nth-child(4) { animation-delay: 300ms; }

@keyframes fadeUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dash-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.dash-card.warning {
    background: linear-gradient(135deg, #FEF3C7, #FDE68A);
    border: 2px solid var(--color-warning);
}

.card-icon {
    font-size: 2rem;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-info-light);
    border-radius: var(--radius-lg);
}

.dash-card.warning .card-icon {
    background: #FEF3C7;
}

.card-info h3 {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.card-number {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-text);
}

/* ================== Ø£Ø²Ø±Ø§Ø± ================== */
.add-btn, .btn-save, .backup-btn {
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: white;
    border: none;
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-family: var(--font-main);
    font-size: 0.9375rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

.add-btn:hover, .btn-save:hover, .backup-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.add-btn:active, .btn-save:active, .backup-btn:active {
    transform: translateY(0);
}

.btn-cancel {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-family: var(--font-main);
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
    transition: all var(--transition-fast);
}

.btn-cancel:hover {
    background: var(--color-bg);
}

.btn-edit, .btn-delete, .btn-return {
    padding: var(--spacing-xs) var(--spacing-sm);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.8125rem;
    font-family: var(--font-main);
    transition: all var(--transition-fast);
    margin-inline-start: var(--spacing-xs);
}

.btn-edit {
    background: var(--color-info-light);
    color: var(--color-primary);
}

.btn-edit:hover {
    background: var(--color-primary);
    color: white;
}

.btn-delete {
    background: var(--color-danger-light);
    color: var(--color-danger);
}

.btn-delete:hover {
    background: var(--color-danger);
    color: white;
}

.btn-return {
    background: var(--color-success-light);
    color: var(--color-success);
}

.btn-return:hover {
    background: var(--color-success);
    color: white;
}

/* ================== Ø§Ù„Ø¨Ø­Ø« ================== */
.search-container {
    margin-bottom: var(--spacing-lg);
}

.search-input {
    width: 100%;
    padding: var(--spacing-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-family: var(--font-main);
    transition: all var(--transition-fast);
}

.search-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-info-light);
}

/* ================== Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ================== */
.table-container {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
}

.data-table thead {
    background: var(--color-bg);
    position: sticky;
    top: 0;
}

.data-table th {
    padding: var(--spacing-md);
    text-align: start;
    font-weight: 600;
    color: var(--color-text-muted);
    border-bottom: 2px solid var(--color-border);
    white-space: nowrap;
}

.data-table td {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
    vertical-align: middle;
}

.data-table tbody tr {
    transition: background var(--transition-fast);
}

.data-table tbody tr:hover {
    background: var(--color-bg);
}

/* ØµÙ Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø± */
.data-table tbody tr.overdue {
    background: var(--color-danger-light);
}

.data-table tbody tr.overdue:hover {
    background: #FECACA;
}

.data-table tbody tr.overdue td:first-child {
    border-inline-start: 4px solid var(--color-danger);
}

/* ================== Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ¨ ================== */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-full);
    font-size: 0.8125rem;
    font-weight: 600;
}

.status-available {
    background: var(--color-success-light);
    color: var(--color-success);
}

.status-borrowed {
    background: var(--color-info-light);
    color: var(--color-primary);
}

.status-overdue {
    background: var(--color-danger-light);
    color: var(--color-danger);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* ================== Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ================== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    inset-inline-start: 0;
    inset-inline-end: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md);
    animation: fadeIn var(--transition-fast);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    animation: slideUp var(--transition-normal);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--color-border);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: var(--spacing-xs);
    line-height: 1;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.modal-close:hover {
    background: var(--color-bg);
    color: var(--color-text);
}

form {
    padding: var(--spacing-lg);
}

.form-group {
    margin-bottom: var(--spacing-lg);
}

.form-group label {
    display: block;
    margin-bottom: var(--spacing-sm);
    font-weight: 600;
    color: var(--color-text);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: var(--spacing-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-family: var(--font-main);
    transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-info-light);
}

.form-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: flex-end;
    margin-top: var(--spacing-xl);
}

/* ================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Toast ================== */
#toast-container {
    position: fixed;
    top: calc(var(--header-height) + var(--spacing-md));
    inset-inline-end: var(--spacing-md);
    z-index: 300;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    pointer-events: none;
}

.toast {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    font-weight: 500;
    min-width: 280px;
    max-width: 400px;
    animation: slideInToast var(--transition-normal) ease-out;
    pointer-events: auto;
}

@keyframes slideInToast {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.toast.toast-hide {
    animation: slideOutToast var(--transition-normal) ease-in forwards;
}

@keyframes slideOutToast {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

.toast-success {
    background: var(--color-success);
    color: white;
}

.toast-error {
    background: var(--color-danger);
    color: white;
}

.toast-warning {
    background: var(--color-warning);
    color: white;
}

.toast-icon {
    font-size: 1.25rem;
}

.toast-message {
    flex: 1;
}

/* ================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ================== */
.reports-section, .backup-section {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
}

.reports-section h3, .backup-section h3 {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
}

.stat-card {
    background: var(--color-bg);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    text-align: center;
}

.stat-card h4 {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    margin-bottom: var(--spacing-sm);
}

.stat-card p {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
}

.backup-info {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
}

.backup-buttons {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.backup-btn.primary {
    background: linear-gradient(135deg, var(--color-success), #059669);
}

.backup-btn.secondary {
    background: linear-gradient(135deg, var(--color-secondary), #5B21B6);
}

.danger-zone {
    margin-top: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: linear-gradient(135deg, #FEE2E2, #FEF2F2);
    border: 2px solid var(--color-danger);
    border-radius: var(--radius-lg);
}

.danger-zone h4 {
    color: var(--color-danger);
    margin-bottom: var(--spacing-sm);
    font-size: 1.1rem;
}

.danger-zone p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-md);
    font-size: 0.9rem;
}

.backup-btn.danger {
    background: linear-gradient(135deg, var(--color-danger), #DC2626);
    color: white;
    border: none;
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    transition: all 0.3s ease;
}

.backup-btn.danger:hover {
    background: linear-gradient(135deg, #DC2626, #B91C1C);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

.backup-btn.danger:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* ================== Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ================== */
.recent-activity {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
}

.recent-activity h3 {
    margin-bottom: var(--spacing-lg);
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.activity-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-bg);
    border-radius: var(--radius-md);
    animation: fadeUp var(--transition-normal);
}

.activity-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    font-size: 1.25rem;
}

.activity-icon.add { background: var(--color-success-light); }
.activity-icon.return { background: var(--color-info-light); }
.activity-icon.borrow { background: var(--color-warning-light); }

.activity-details {
    flex: 1;
}

.activity-details p {
    font-weight: 500;
    margin-bottom: 2px;
}

.activity-details span {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
}

.empty-state {
    text-align: center;
    color: var(--color-text-muted);
    padding: var(--spacing-xl);
}

/* ================== Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ ================== */
.offline-status {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
}

.offline-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-success);
}

body.offline .offline-status::before {
    background: var(--color-danger);
}

body.offline .offline-status {
    color: var(--color-danger);
}

/* ================== Ø§Ù„ØªØ°ÙŠÙŠÙ„ ================== */
.app-footer {
    text-align: center;
    padding: var(--spacing-lg);
    color: var(--color-text-muted);
    font-size: 0.875rem;
    background: var(--color-surface);
    border-top: 1px solid var(--color-border);
    margin-bottom: var(--nav-height);
}

/* ================== ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ================== */
.animate-add {
    animation: bounceIn 0.5s ease-out;
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.animate-slide {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* ================== Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ ================== */
@media (min-width: 768px) {
    .main-nav {
        position: fixed;
        top: var(--header-height);
        bottom: 0;
        inset-inline-start: 0;
        width: 250px;
        border-top: none;
        border-inline-end: 1px solid var(--color-border);
        box-shadow: var(--shadow-md);
    }

    .nav-list {
        flex-direction: column;
        padding: var(--spacing-md);
        gap: var(--spacing-xs);
    }

    .nav-link {
        flex-direction: row;
        width: 100%;
        justify-content: flex-start;
        padding: var(--spacing-md);
    }

    .main-content {
        margin-inline-start: 250px;
        padding-bottom: var(--spacing-xl);
    }

    body {
        padding-bottom: 0;
    }

    .app-footer {
        margin-bottom: 0;
        margin-inline-start: 250px;
    }

    #toast-container {
        top: var(--spacing-lg);
        inset-inline-end: var(--spacing-lg);
    }
}

@media (max-width: 480px) {
    .dashboard-cards {
        grid-template-columns: 1fr 1fr;
    }

    .dash-card {
        flex-direction: column;
        text-align: center;
        padding: var(--spacing-md);
    }

    .card-icon {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
    }

    .card-number {
        font-size: 1.25rem;
    }

    .section-header {
        flex-direction: column;
        align-items: stretch;
    }

    .add-btn {
        justify-content: center;
    }

    .data-table {
        font-size: 0.8125rem;
    }

    .data-table th,
    .data-table td {
        padding: var(--spacing-sm);
    }

    .backup-buttons {
        flex-direction: column;
    }

    .backup-btn {
        justify-content: center;
    }
}

/* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
    .main-nav,
    .app-header,
    .add-btn,
    .btn-edit,
    .btn-delete,
    .btn-return,
    .search-container,
    .app-footer {
        display: none !important;
    }

    .main-content {
        margin: 0;
        padding: 0;
    }

    .table-container {
        box-shadow: none;
    }
}
    </style>
</head>
<body>
    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Toast -->
    <div id="toast-container"></div>

    <!-- Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="app-title">ğŸ“š Ù…ÙƒØªØ¨ØªÙŠ</h1>
            <button class="menu-toggle" id="menuToggle" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <nav class="main-nav" id="mainNav">
        <ul class="nav-list">
            <li><a href="#dashboard" class="nav-link active" data-section="dashboard">
                <span class="nav-icon">ğŸ </span>
                <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
            </a></li>
            <li><a href="#books" class="nav-link" data-section="books">
                <span class="nav-icon">ğŸ“–</span>
                <span>Ø§Ù„ÙƒØªØ¨</span>
            </a></li>
            <li><a href="#students" class="nav-link" data-section="students">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>Ø§Ù„Ø·Ù„Ø§Ø¨</span>
            </a></li>
            <li><a href="#borrows" class="nav-link" data-section="borrows">
                <span class="nav-icon">ğŸ“‹</span>
                <span>Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª</span>
            </a></li>
            <li><a href="#reports" class="nav-link" data-section="reports">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø®</span>
            </a></li>
        </ul>
    </nav>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="main-content">
        <!-- Ù‚Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
        <section id="dashboard" class="section active">
            <div class="section-header">
                <button class="back-btn" style="display: none;">â† Ø±Ø¬ÙˆØ¹</button>
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            </div>
            <div class="dashboard-cards">
                <div class="dash-card" data-animate="fade-up">
                    <div class="card-icon">ğŸ“š</div>
                    <div class="card-info">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨</h3>
                        <p class="card-number" id="totalBooks">0</p>
                    </div>
                </div>
                <div class="dash-card" data-animate="fade-up">
                    <div class="card-icon">ğŸ“‹</div>
                    <div class="card-info">
                        <h3>Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                        <p class="card-number" id="activeBorrows">0</p>
                    </div>
                </div>
                <div class="dash-card warning" data-animate="fade-up">
                    <div class="card-icon">âš ï¸</div>
                    <div class="card-info">
                        <h3>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</h3>
                        <p class="card-number" id="overdueBooks">0</p>
                    </div>
                </div>
                <div class="dash-card" data-animate="fade-up">
                    <div class="card-icon">ğŸ‘¥</div>
                    <div class="card-info">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <p class="card-number" id="totalStudents">0</p>
                    </div>
                </div>
            </div>
            <div class="recent-activity">
                <h3>Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
                <div id="recentActivity" class="activity-list">
                    <p class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«</p>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„ÙƒØªØ¨ -->
        <section id="books" class="section">
            <div class="section-header">
                <button class="back-btn" style="display: none;">â† Ø±Ø¬ÙˆØ¹</button>
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªØ¨</h2>
                <button class="add-btn" id="addBookBtn">â• Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨</button>
            </div>
            <div class="search-container">
                <input type="text" id="bookSearch" class="search-input" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ØŒ Ø§Ù„Ù…Ø¤Ù„ÙØŒ Ø§Ù„ÙØ¦Ø©...">
            </div>
            <div class="table-container">
                <table class="data-table" id="booksTable">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù…</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ù…Ø¤Ù„Ù</th>
                            <th>Ø§Ù„ÙØ¦Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="booksTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <section id="students" class="section">
            <div class="section-header">
                <button class="back-btn" style="display: none;">â† Ø±Ø¬ÙˆØ¹</button>
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                <button class="add-btn" id="addStudentBtn">â• ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨</button>
            </div>
            <div class="search-container">
                <input type="text" id="studentSearch" class="search-input" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„ØµÙØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
            </div>
            <div class="table-container">
                <table class="data-table" id="studentsTable">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù…</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„ØµÙ</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª -->
        <section id="borrows" class="section">
            <div class="section-header">
                <button class="back-btn" style="display: none;">â† Ø±Ø¬ÙˆØ¹</button>
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª</h2>
                <button class="add-btn" id="newBorrowBtn">â• Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
            <div class="search-container">
                <input type="text" id="borrowSearch" class="search-input" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ Ø£Ùˆ Ø·Ø§Ù„Ø¨...">
            </div>
            <div class="table-container">
                <table class="data-table" id="borrowsTable">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù…</th>
                            <th>Ø§Ù„ÙƒØªØ§Ø¨</th>
                            <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="borrowsTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
        <section id="reports" class="section">
            <div class="section-header">
                <button class="back-btn" style="display: none;">â† Ø±Ø¬ÙˆØ¹</button>
                <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>
            </div>

            <div class="reports-section">
                <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø©</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</h4>
                        <p id="borrowRatio">0%</p>
                    </div>
                    <div class="stat-card">
                        <h4>Ù…ØªÙˆØ³Ø· Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</h4>
                        <p id="avgBorrowDays">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¹Ø§Ø±Ø©</h4>
                        <p id="topBorrower">-</p>
                    </div>
                </div>
            </div>

            <div class="backup-section">
                <h3>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h3>
                <p class="backup-info">ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©</p>
                <div class="backup-buttons">
                    <button class="backup-btn primary" id="exportBtn">
                        <span class="btn-icon">ğŸ’¾</span>
                        ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                    </button>
                    <button class="backup-btn secondary" id="importBtn">
                        <span class="btn-icon">ğŸ“‚</span>
                        Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
                <div class="danger-zone">
                    <h4>âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h4>
                    <p>Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</p>
                    <button class="backup-btn danger" id="resetBtn">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                        Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Modals) -->
    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bookModalTitle">Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <button class="modal-close" data-close="bookModal">&times;</button>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-group">
                    <label for="bookTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ *</label>
                    <input type="text" id="bookTitle" required>
                </div>
                <div class="form-group">
                    <label for="bookAuthor">Ø§Ù„Ù…Ø¤Ù„Ù *</label>
                    <input type="text" id="bookAuthor" required>
                </div>
                <div class="form-group">
                    <label for="bookCategory">Ø§Ù„ÙØ¦Ø© *</label>
                    <select id="bookCategory" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                        <option value="Ø¹Ù„Ù…ÙŠ">Ø¹Ù„Ù…ÙŠ</option>
                        <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
                        <option value="ØªØ§Ø±ÙŠØ®">ØªØ§Ø±ÙŠØ®</option>
                        <option value="Ø¯ÙŠÙ†ÙŠ">Ø¯ÙŠÙ†ÙŠ</option>
                        <option value="Ø±ÙŠØ§Ø¶ÙŠ">Ø±ÙŠØ§Ø¶ÙŠ</option>
                        <option value="ÙÙ†ÙˆÙ†">ÙÙ†ÙˆÙ†</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bookQuantity">Ø§Ù„Ø¹Ø¯Ø¯ *</label>
                    <input type="number" id="bookQuantity" min="1" value="1" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" data-close="bookModal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="studentModalTitle">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <button class="modal-close" data-close="studentModal">&times;</button>
            </div>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label for="studentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ *</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label for="studentClass">Ø§Ù„ØµÙ *</label>
                    <input type="text" id="studentClass" required>
                </div>
                <div class="form-group">
                    <label for="studentPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="studentPhone">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" data-close="studentModal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="modal" id="borrowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø§Ø³ØªØ¹Ø§Ø±Ø© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <button class="modal-close" data-close="borrowModal">&times;</button>
            </div>
            <form id="borrowForm">
                <input type="hidden" id="borrowId">
                <div class="form-group">
                    <label for="borrowBookSearch">Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨</label>
                    <input type="text" id="borrowBookSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù…Ø¤Ù„Ù..." oninput="filterBorrowBooks(this.value)">
                </div>
                <div class="form-group">
                    <label for="borrowBook">Ø§Ø®ØªØ± Ø§Ù„ÙƒØªØ§Ø¨ *</label>
                    <select id="borrowBook" required>
                        <option value="">Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="borrowStudentSearch">Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨</label>
                    <input type="text" id="borrowStudentSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØµÙ..." oninput="filterBorrowStudents(this.value)">
                </div>
                <div class="form-group">
                    <label for="borrowStudent">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ *</label>
                    <select id="borrowStudent" required>
                        <option value="">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="borrowDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø© *</label>
                    <input type="date" id="borrowDate" required>
                </div>
                <div class="form-group">
                    <label for="dueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ *</label>
                    <input type="date" id="dueDate" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" data-close="borrowModal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
    <footer class="app-footer">
        <p>Ù…ÙƒØªØ¨ØªÙŠ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© Â© 2025</p>
        <p class="offline-status" id="offlineStatus">Ù…ØªØµÙ„</p>
    </footer>

    <script>
/* ============================================
   Ù…ÙƒØªØ¨ØªÙŠ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©
   Ù…Ù„Ù JavaScript Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
   ============================================ */

// ================== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==================
const DB = {
    books: [],
    students: [],
    borrows: []
};

// Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ LocalStorage
const STORAGE_KEYS = {
    books: 'maktabati_books',
    students: 'maktabati_students',
    borrows: 'maktabati_borrows'
};

// ================== Ø§Ù„Ø£ØµÙˆØ§Øª ==================
const sounds = {
    success: null,
    error: null,
    click: null
};

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆØ§Øª
function initSounds() {
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø£ØµÙˆØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API
        sounds.success = createSound(800, 0.1, 'sine');
        sounds.error = createSound(300, 0.2, 'sawtooth');
        sounds.click = createSound(600, 0.05, 'sine');
    } catch (e) {
        console.log('Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
    }
}

function createSound(frequency, duration, type) {
    return function() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = type;

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
            console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
        }
    };
}

function playSound(type) {
    if (sounds[type]) {
        sounds[type]();
    }
}

// ================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Toast ==================
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');

    const icons = {
        success: 'âœ“',
        error: 'âœ•',
        warning: 'âš '
    };

    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
    `;

    container.appendChild(toast);

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (type === 'success') playSound('success');
    if (type === 'error') playSound('error');

    // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        toast.classList.add('toast-hide');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

// ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==================
function loadData() {
    try {
        const books = localStorage.getItem(STORAGE_KEYS.books);
        const students = localStorage.getItem(STORAGE_KEYS.students);
        const borrows = localStorage.getItem(STORAGE_KEYS.borrows);

        DB.books = books ? JSON.parse(books) : [];
        DB.students = students ? JSON.parse(students) : [];
        DB.borrows = borrows ? JSON.parse(borrows) : [];
    } catch (e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
        DB.books = [];
        DB.students = [];
        DB.borrows = [];
    }
}

function saveData() {
    try {
        localStorage.setItem(STORAGE_KEYS.books, JSON.stringify(DB.books));
        localStorage.setItem(STORAGE_KEYS.students, JSON.stringify(DB.students));
        localStorage.setItem(STORAGE_KEYS.borrows, JSON.stringify(DB.borrows));
    } catch (e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

// ================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ==================
function getToday() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return today;
}

function parseDate(dateStr) {
    const date = new Date(dateStr);
    date.setHours(0, 0, 0, 0);
    return date;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

function isOverdue(dueDate) {
    if (!dueDate) return false;
    const today = getToday();
    const due = parseDate(dueDate);
    return due < today;
}

// ================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==================
function validateBackupData(data) {
    if (!data || typeof data !== 'object') {
        return { valid: false, error: 'Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ ÙƒØ§Ø¦Ù† ØµØ§Ù„Ø­' };
    }

    const requiredKeys = ['books', 'students', 'borrows'];
    for (const key of requiredKeys) {
        if (!data[key] || !Array.isArray(data[key])) {
            return { valid: false, error: `Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: ${key}` };
        }
    }

    return { valid: true };
}

// ================== ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ==================
function exportBackup() {
    try {
        const data = {
            books: DB.books,
            students: DB.students,
            borrows: DB.borrows,
            exportDate: new Date().toISOString(),
            version: '1.0'
        };

        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'maktabati-backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        playSound('success');
    } catch (e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', e);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
    }
}

function importBackup(file) {
    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const validation = validateBackupData(data);
            if (!validation.valid) {
                showToast(validation.error, 'error');
                return;
            }

            // Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
            if (!confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'warning');
                return;
            }

            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            DB.books = data.books || [];
            DB.students = data.students || [];
            DB.borrows = data.borrows || [];

            saveData();
            refreshAllViews();

            showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            playSound('success');
        } catch (e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', e);
            showToast('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
            playSound('error');
        }
    };

    reader.onerror = function() {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
    };

    reader.readAsText(file);
}

// ================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª ==================
function hasActiveBorrows(bookId) {
    return DB.borrows.some(b => b.bookId === bookId && !b.returned);
}

function hasActiveBorrowsForStudent(studentId) {
    return DB.borrows.some(b => b.studentId === studentId && !b.returned);
}

function getStudentActiveBorrowsCount(studentId) {
    return DB.borrows.filter(b => b.studentId === studentId && !b.returned).length;
}

function getOverdueCount() {
    return DB.borrows.filter(b => !b.returned && isOverdue(b.dueDate)).length;
}

// ================== Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† ==================
function searchItems(items, query, fields) {
    if (!query || !query.trim()) return items;

    const searchTerm = query.trim().toLowerCase();

    return items.filter(item => {
        return fields.some(field => {
            const value = item[field];
            if (value === undefined || value === null) return false;
            return String(value).toLowerCase().includes(searchTerm);
        });
    });
}

function getBookById(id) {
    return DB.books.find(b => b.id === id);
}

function getStudentById(id) {
    return DB.students.find(s => s.id === id);
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„ÙƒØªØ§Ø¨
function getActiveBorrowsCount(bookId) {
    return DB.borrows.filter(b => b.bookId === bookId && !b.returned).length;
}

// ================== Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ==================
function renderDashboard() {
    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨
    document.getElementById('totalBooks').textContent = DB.books.length;

    // Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
    const activeBorrows = DB.borrows.filter(b => !b.returned).length;
    document.getElementById('activeBorrows').textContent = activeBorrows;

    // Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
    const overdueCount = getOverdueCount();
    document.getElementById('overdueBooks').textContent = overdueCount;

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨
    document.getElementById('totalStudents').textContent = DB.students.length;

    // Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
    renderRecentActivity();
}

function renderRecentActivity() {
    const container = document.getElementById('recentActivity');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 5 Ù†Ø´Ø§Ø·Ø§Øª
    const recentBorrows = [...DB.borrows]
        .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
        .slice(0, 5);

    if (recentBorrows.length === 0) {
        container.innerHTML = '<p class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«</p>';
        return;
    }

    container.innerHTML = recentBorrows.map(borrow => {
        const book = getBookById(borrow.bookId);
        const student = getStudentById(borrow.studentId);
        const isLate = !borrow.returned && isOverdue(borrow.dueDate);

        let icon, activityText;
        if (borrow.returned) {
            icon = 'return';
            activityText = `ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ "${book?.title || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}"`;
        } else if (isLate) {
            icon = 'borrow';
            activityText = `Ø§Ø³ØªØ¹Ø§Ø±Ø© Ù…ØªØ£Ø®Ø±Ø©: "${book?.title || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}"`;
        } else {
            icon = 'borrow';
            activityText = `Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©: "${book?.title || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}"`;
        }

        return `
            <div class="activity-item">
                <div class="activity-icon ${icon}">
                    ${borrow.returned ? 'â†©ï¸' : 'ğŸ“–'}
                </div>
                <div class="activity-details">
                    <p>${student?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                    <span>${activityText} - ${formatDate(borrow.borrowDate)}</span>
                </div>
            </div>
        `;
    }).join('');
}

// ================== Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ ==================
function renderBooks(books = null) {
    const tbody = document.getElementById('booksTableBody');
    const items = books || DB.books;

    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø³Ø¬Ù„Ø©
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = items.map((book, index) => {
        const isBorrowed = hasActiveBorrows(book.id);
        const available = book.quantity - getActiveBorrowsCount(book.id);

        return `
            <tr>
                <td>${index + 1}</td>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.category}</td>
                <td>
                    <span class="status-badge ${isBorrowed ? 'status-borrowed' : 'status-available'}">
                        ${isBorrowed ? 'Ù…Ø³ØªØ¹Ø§Ø±' : 'Ù…ØªØ§Ø­'}
                    </span>
                </td>
                <td>
                    <button class="btn-edit" onclick="editBook(${book.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-delete" onclick="deleteBook(${book.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterBooks() {
    const query = document.getElementById('bookSearch').value;
    const filtered = searchItems(DB.books, query, ['title', 'author', 'category']);
    renderBooks(filtered);
}

// ================== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ ==================
function renderStudents(students = null) {
    const tbody = document.getElementById('studentsTableBody');
    const items = students || DB.students;

    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ†
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = items.map((student, index) => {
        const borrowCount = getStudentActiveBorrowsCount(student.id);

        return `
            <tr>
                <td>${index + 1}</td>
                <td>${student.name}</td>
                <td>${student.class}</td>
                <td>${student.phone || '-'}</td>
                <td>
                    <span class="status-badge ${borrowCount > 0 ? 'status-borrowed' : 'status-available'}">
                        ${borrowCount} ÙƒØªØ¨
                    </span>
                </td>
                <td>
                    <button class="btn-edit" onclick="editStudent(${student.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-delete" onclick="deleteStudent(${student.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterStudents() {
    const query = document.getElementById('studentSearch').value;
    const filtered = searchItems(DB.students, query, ['name', 'class', 'phone']);
    renderStudents(filtered);
}

// ================== Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª ==================
function renderBorrows(borrows = null) {
    const tbody = document.getElementById('borrowsTableBody');
    const items = borrows || DB.borrows;

    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = items.map((borrow, index) => {
        const book = getBookById(borrow.bookId);
        const student = getStudentById(borrow.studentId);
        const isLate = !borrow.returned && isOverdue(borrow.dueDate);

        let statusText, statusClass;
        if (borrow.returned) {
            statusText = 'Ù…ÙØ±Ø¬Ø¹';
            statusClass = 'status-available';
        } else if (isLate) {
            statusText = 'Ù…ØªØ£Ø®Ø±';
            statusClass = 'status-overdue';
        } else {
            statusText = 'Ù…Ø³ØªØ¹Ø§Ø±';
            statusClass = 'status-borrowed';
        }

        const rowClass = isLate ? 'overdue' : '';

        return `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${book?.title || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${student?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${formatDate(borrow.borrowDate)}</td>
                <td>${formatDate(borrow.dueDate)}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    ${!borrow.returned ? `<button class="btn-edit" onclick="editBorrow(${borrow.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>` : ''}
                    ${!borrow.returned ? `<button class="btn-return" onclick="returnBook(${borrow.id})">â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹</button>` : ''}
                    <button class="btn-delete" onclick="deleteBorrow(${borrow.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterBorrows() {
    const query = document.getElementById('borrowSearch').value;
    if (!query || !query.trim()) {
        renderBorrows();
        return;
    }

    const searchTerm = query.trim().toLowerCase();

    const filtered = DB.borrows.filter(borrow => {
        const book = getBookById(borrow.bookId);
        const student = getStudentById(borrow.studentId);

        return (
            (book && book.title.toLowerCase().includes(searchTerm)) ||
            (book && book.author && book.author.toLowerCase().includes(searchTerm)) ||
            (student && student.name.toLowerCase().includes(searchTerm))
        );
    });

    renderBorrows(filtered);
}

// ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªØ¨ ==================
function openBookModal(book = null) {
    const modal = document.getElementById('bookModal');
    const form = document.getElementById('bookForm');
    const title = document.getElementById('bookModalTitle');

    form.reset();

    if (book) {
        title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ ÙƒØªØ§Ø¨';
        document.getElementById('bookId').value = book.id;
        document.getElementById('bookTitle').value = book.title;
        document.getElementById('bookAuthor').value = book.author;
        document.getElementById('bookCategory').value = book.category;
        document.getElementById('bookQuantity').value = book.quantity;
    } else {
        title.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('bookId').value = '';
    }

    modal.classList.add('active');
    playSound('click');
}

function saveBook(e) {
    e.preventDefault();

    const id = document.getElementById('bookId').value;
    const title = document.getElementById('bookTitle').value.trim();
    const author = document.getElementById('bookAuthor').value.trim();
    const category = document.getElementById('bookCategory').value;
    const quantity = parseInt(document.getElementById('bookQuantity').value);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!title || !author || !category || !quantity) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }

    if (id) {
        // ØªØ­Ø¯ÙŠØ« ÙƒØªØ§Ø¨ Ù…ÙˆØ¬ÙˆØ¯
        const index = DB.books.findIndex(b => b.id === parseInt(id));
        if (index !== -1) {
            DB.books[index] = {
                ...DB.books[index],
                title,
                author,
                category,
                quantity
            };
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
    } else {
        // Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯
        const newBook = {
            id: Date.now(),
            title,
            author,
            category,
            quantity,
            createdAt: new Date().toISOString()
        };
        DB.books.push(newBook);
        showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');

        // ØªØ£Ø«ÙŠØ± Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        setTimeout(() => {
            const tbody = document.getElementById('booksTableBody');
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 0) {
                rows[0].classList.add('animate-add');
            }
        }, 100);
    }

    saveData();
    renderBooks();
    renderDashboard();
    closeModal('bookModal');
    playSound('success');
}

function editBook(id) {
    const book = getBookById(id);
    if (book) {
        openBookModal(book);
    }
}

function deleteBook(id) {
    const book = getBookById(id);
    if (!book) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©
    if (hasActiveBorrows(id)) {
        showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ù„Ø£Ù†Ù‡ Ù…Ø³ØªØ¹Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹', 'error');
        playSound('error');
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${book.title}"ØŸ`)) return;

    DB.books = DB.books.filter(b => b.id !== id);
    saveData();
    renderBooks();
    renderDashboard();
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ==================
function openStudentModal(student = null) {
    const modal = document.getElementById('studentModal');
    const form = document.getElementById('studentForm');
    const title = document.getElementById('studentModalTitle');

    form.reset();

    if (student) {
        title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨';
        document.getElementById('studentId').value = student.id;
        document.getElementById('studentName').value = student.name;
        document.getElementById('studentClass').value = student.class;
        document.getElementById('studentPhone').value = student.phone || '';
    } else {
        title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('studentId').value = '';
    }

    modal.classList.add('active');
    playSound('click');
}

function saveStudent(e) {
    e.preventDefault();

    const id = document.getElementById('studentId').value;
    const name = document.getElementById('studentName').value.trim();
    const classVal = document.getElementById('studentClass').value.trim();
    const phone = document.getElementById('studentPhone').value.trim();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!name || !classVal) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙ', 'error');
        return;
    }

    if (id) {
        // ØªØ­Ø¯ÙŠØ« Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯
        const index = DB.students.findIndex(s => s.id === parseInt(id));
        if (index !== -1) {
            DB.students[index] = {
                ...DB.students[index],
                name,
                class: classVal,
                phone
            };
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        const newStudent = {
            id: Date.now(),
            name,
            class: classVal,
            phone,
            createdAt: new Date().toISOString()
        };
        DB.students.push(newStudent);
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');

        // ØªØ£Ø«ÙŠØ± Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        setTimeout(() => {
            const tbody = document.getElementById('studentsTableBody');
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 0) {
                rows[0].classList.add('animate-add');
            }
        }, 100);
    }

    saveData();
    renderStudents();
    renderDashboard();
    closeModal('studentModal');
    playSound('success');
}

function editStudent(id) {
    const student = getStudentById(id);
    if (student) {
        openStudentModal(student);
    }
}

function deleteStudent(id) {
    const student = getStudentById(id);
    if (!student) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©
    if (hasActiveBorrowsForStudent(id)) {
        showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø£Ù†Ù‡ Ù„Ø¯ÙŠÙ‡ Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©', 'error');
        playSound('error');
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${student.name}"ØŸ`)) return;

    DB.students = DB.students.filter(s => s.id !== id);
    saveData();
    renderStudents();
    renderDashboard();
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª ==================
function openBorrowModal() {
    const modal = document.getElementById('borrowModal');
    const form = document.getElementById('borrowForm');

    form.reset();
    document.getElementById('borrowId').value = '';

    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©
    const bookSelect = document.getElementById('borrowBook');
    bookSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹</option>';

    DB.books.forEach(book => {
        const available = book.quantity - getActiveBorrowsCount(book.id);
        if (available > 0) {
            bookSelect.innerHTML += `
                <option value="${book.id}">${book.title} (Ù…ØªØ§Ø­: ${available})</option>
            `;
        }
    });

    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
    const studentSelect = document.getElementById('borrowStudent');
    studentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹</option>';

    DB.students.forEach(student => {
        studentSelect.innerHTML += `
            <option value="${student.id}">${student.name} - ${student.class}</option>
        `;
    });

    // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    const today = new Date().toISOString().split('T')[0];
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 14); // Ø§ÙØªØ±Ø§Ø¶ÙŠ 14 ÙŠÙˆÙ…
    const dueDateStr = dueDate.toISOString().split('T')[0];

    document.getElementById('borrowDate').value = today;
    document.getElementById('dueDate').value = dueDateStr;

    const modalHeader = modal.querySelector('.modal-header h3');
    modalHeader.textContent = 'Ø§Ø³ØªØ¹Ø§Ø±Ø© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯';

    modal.classList.add('active');
    playSound('click');
}

// Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
function editBorrow(borrowId) {
    const borrow = DB.borrows.find(b => b.id === borrowId);
    if (!borrow || borrow.returned) return;

    const modal = document.getElementById('borrowModal');
    const form = document.getElementById('borrowForm');

    form.reset();

    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©
    const bookSelect = document.getElementById('borrowBook');
    bookSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹</option>';

    DB.books.forEach(book => {
        const available = book.quantity - getActiveBorrowsCount(book.id);
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù…ØªØ§Ø­Ø§Ù‹
        if (available > 0 || book.id === borrow.bookId) {
            bookSelect.innerHTML += `
                <option value="${book.id}" ${book.id === borrow.bookId ? 'selected' : ''}>${book.title} (Ù…ØªØ§Ø­: ${available})</option>
            `;
        }
    });

    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
    const studentSelect = document.getElementById('borrowStudent');
    studentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹</option>';

    DB.students.forEach(student => {
        studentSelect.innerHTML += `
            <option value="${student.id}" ${student.id === borrow.studentId ? 'selected' : ''}>${student.name} - ${student.class}</option>
        `;
    });

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    document.getElementById('borrowDate').value = borrow.borrowDate;
    document.getElementById('dueDate').value = borrow.dueDate;
    document.getElementById('borrowId').value = borrowId;

    // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const modalHeader = modal.querySelector('.modal-header h3');
    modalHeader.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©';

    modal.classList.add('active');
    playSound('click');
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØªØ¨ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
function filterBorrowBooks(query) {
    const bookSelect = document.getElementById('borrowBook');
    const searchTerm = query.toLowerCase().trim();

    bookSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹</option>';

    DB.books.forEach(book => {
        const available = book.quantity - getActiveBorrowsCount(book.id);
        if (available > 0) {
            const title = book.title.toLowerCase();
            const author = (book.author || '').toLowerCase();
            const category = (book.category || '').toLowerCase();

            if (searchTerm === '' || title.includes(searchTerm) || author.includes(searchTerm) || category.includes(searchTerm)) {
                bookSelect.innerHTML += `
                    <option value="${book.id}">${book.title} (Ù…ØªØ§Ø­: ${available})</option>
                `;
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
function filterBorrowStudents(query) {
    const studentSelect = document.getElementById('borrowStudent');
    const searchTerm = query.toLowerCase().trim();

    studentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹</option>';

    DB.students.forEach(student => {
        const name = student.name.toLowerCase();
        const className = (student.class || '').toLowerCase();

        if (searchTerm === '' || name.includes(searchTerm) || className.includes(searchTerm)) {
            studentSelect.innerHTML += `
                <option value="${student.id}">${student.name} - ${student.class}</option>
            `;
        }
    });
}

// Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
let isBorrowing = false;

function saveBorrow(e) {
    e.preventDefault();

    try {
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (isBorrowing) {
            showToast('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...', 'warning');
            return;
        }
        isBorrowing = true;

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…
        const bookId = parseInt(document.getElementById('borrowBook').value);
        const studentId = parseInt(document.getElementById('borrowStudent').value);
        const borrowDate = document.getElementById('borrowDate').value;
        const dueDate = document.getElementById('dueDate').value;
        const borrowId = parseInt(document.getElementById('borrowId').value) || null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (!bookId || !studentId || !borrowDate || !dueDate) {
            showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
            isBorrowing = false;
            return;
        }

        if (isNaN(bookId) || isNaN(studentId)) {
            showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒØªØ§Ø¨ ÙˆØ·Ø§Ù„Ø¨ ØµØ­ÙŠØ­ÙŠÙ†', 'error');
            isBorrowing = false;
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„ÙƒØªØ§Ø¨
        const book = getBookById(bookId);
        if (!book) {
            showToast('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
            isBorrowing = false;
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØªÙˆÙØ±Ø©
        const activeBorrows = DB.borrows.filter(b => b.bookId === bookId && !b.returned && b.id !== borrowId).length;
        const available = (book.quantity || 0) - activeBorrows;

        if (available <= 0 && !borrowId) {
            showToast('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ± - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ' + available, 'error');
            isBorrowing = false;
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        if (borrowId) {
            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³ØªØ¹Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
            const borrowIndex = DB.borrows.findIndex(b => b.id === borrowId);
            if (borrowIndex !== -1) {
                DB.borrows[borrowIndex] = {
                    ...DB.borrows[borrowIndex],
                    bookId,
                    studentId,
                    borrowDate,
                    dueDate
                };
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
            const newBorrow = {
                id: Date.now(),
                bookId,
                studentId,
                borrowDate,
                dueDate,
                returned: false,
                returnDate: null,
                createdAt: new Date().toISOString()
            };

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
            DB.borrows.push(newBorrow);
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveData();

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        const modal = document.getElementById('borrowModal');
        if (modal) modal.classList.remove('active');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        refreshAllViews();

        playSound('success');

    } catch (error) {
        console.error('Error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©', 'error');
        playSound('error');
    } finally {
        isBorrowing = false;
    }
}

function returnBook(borrowId) {
    const borrow = DB.borrows.find(b => b.id === borrowId);
    if (!borrow || borrow.returned) return;

    if (!confirm('Ù‡Ù„ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨ØŸ')) return;

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
    borrow.returned = true;
    borrow.returnDate = new Date().toISOString().split('T')[0];

    saveData();
    renderBorrows();
    renderBooks();
    renderDashboard();
    showToast('ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    playSound('success');
}

function deleteBorrow(borrowId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©ØŸ')) return;

    DB.borrows = DB.borrows.filter(b => b.id !== borrowId);
    saveData();
    renderBorrows();
    renderBooks();
    renderDashboard();
    showToast('ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// ================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ==================
function renderReports() {
    // Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©
    const totalBooks = DB.books.reduce((sum, b) => sum + (b.quantity || 0), 0);
    const borrowedBooks = DB.borrows.filter(b => !b.returned).length;
    const ratio = totalBooks > 0 ? Math.round((borrowedBooks / totalBooks) * 100) : 0;
    document.getElementById('borrowRatio').textContent = `${ratio}%`;

    // Ù…ØªÙˆØ³Ø· Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©
    const returnedBorrows = DB.borrows.filter(b => b.returned && b.returnDate);
    if (returnedBorrows.length > 0) {
        const totalDays = returnedBorrows.reduce((sum, b) => {
            const borrowDate = new Date(b.borrowDate);
            const returnDate = new Date(b.returnDate);
            const days = Math.ceil((returnDate - borrowDate) / (1000 * 60 * 60 * 24));
            return sum + days;
        }, 0);
        const avgDays = Math.round(totalDays / returnedBorrows.length);
        document.getElementById('avgBorrowDays').textContent = `${avgDays} ÙŠÙˆÙ…`;
    } else {
        document.getElementById('avgBorrowDays').textContent = '-';
    }

    // Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¹Ø§Ø±Ø©
    const studentBorrowCount = {};
    DB.borrows.forEach(b => {
        studentBorrowCount[b.studentId] = (studentBorrowCount[b.studentId] || 0) + 1;
    });

    let topStudentId = null;
    let maxCount = 0;
    for (const [id, count] of Object.entries(studentBorrowCount)) {
        if (count > maxCount) {
            maxCount = count;
            topStudentId = id;
        }
    }

    const topStudent = topStudentId ? getStudentById(parseInt(topStudentId)) : null;
    document.getElementById('topBorrower').textContent = topStudent ? topStudent.name : '-';
}

// ================== Ø§Ù„ØªÙ†Ù‚Ù„ ==================
function setupNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            const targetId = link.getAttribute('href').substring(1);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†Ø´Ø·Ø©
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetId) {
                    section.classList.add('active');
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
            if (targetId === 'dashboard') {
                renderDashboard();
            } else if (targetId === 'books') {
                renderBooks();
            } else if (targetId === 'students') {
                renderStudents();
            } else if (targetId === 'borrows') {
                renderBorrows();
            } else if (targetId === 'reports') {
                renderReports();
            }

            playSound('click');

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            document.getElementById('mainNav').classList.remove('active');
        });
    });
}

// ================== Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ==================
function setupModals() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });

    // Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => {
            const modalId = btn.getAttribute('data-close');
            closeModal(modalId);
        });
    });
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

// ================== ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ ==================
function refreshAllViews() {
    renderDashboard();
    renderBooks();
    renderStudents();
    renderBorrows();
    renderReports();
}

// ================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« ==================
function setupSearch() {
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØªØ¨
    document.getElementById('bookSearch').addEventListener('input', debounce(filterBooks, 300));

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨
    document.getElementById('studentSearch').addEventListener('input', debounce(filterStudents, 300));

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª
    document.getElementById('borrowSearch').addEventListener('input', debounce(filterBorrows, 300));
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± (Debounce)
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ==================
function setupBackup() {
    document.getElementById('exportBtn').addEventListener('click', exportBackup);

    document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            importBackup(file);
            e.target.value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù„Ù
        }
    });

    // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('resetBtn').addEventListener('click', resetAllData);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let isResetting = false;

function resetAllData() {
    if (isResetting) {
        showToast('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...', 'warning');
        return;
    }

    // Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª')) {
        return;
    }

    // Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ (ØªØ­Ø°ÙŠØ±ÙŠ)
    if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ âš ï¸\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!\n\nØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….\n\nØ§Ø¶ØºØ· "Ù…ÙˆØ§ÙÙ‚" Ù„Ù„Ø­Ø°Ù Ø£Ùˆ "Ø¥Ù„ØºØ§Ø¡" Ù„Ù„ØªØ±Ø§Ø¬Ø¹.')) {
        return;
    }

    // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù
    isResetting = true;
    const resetBtn = document.getElementById('resetBtn');
    resetBtn.disabled = true;
    resetBtn.innerHTML = '<span class="btn-icon">â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

    try {
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        DB.books = [];
        DB.students = [];
        DB.borrows = [];

        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage
        localStorage.removeItem(STORAGE_KEYS.books);
        localStorage.removeItem(STORAGE_KEYS.students);
        localStorage.removeItem(STORAGE_KEYS.borrows);

        // Ø­ÙØ¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
        saveData();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderBooks();
        renderStudents();
        renderBorrows();
        renderDashboard();

        showToast('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.', 'success');
        playSound('success');

        console.log('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        playSound('error');
    } finally {
        isResetting = false;
        resetBtn.disabled = false;
        resetBtn.innerHTML = '<span class="btn-icon">ğŸ—‘ï¸</span> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
}

// ================== Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ==================
function setupOnlineStatus() {
    function updateStatus() {
        const status = document.getElementById('offlineStatus');
        if (navigator.onLine) {
            status.textContent = 'Ù…ØªØµÙ„';
            document.body.classList.remove('offline');
        } else {
            status.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
            document.body.classList.add('offline');
        }
    }

    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    updateStatus();
}

// ================== ØªØ³Ø¬ÙŠÙ„ Service Worker ==================
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker Ù…Ø³Ø¬Ù„:', reg.scope))
            .catch(err => console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err));
    }
}

// ================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==================
function init() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    loadData();

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆØ§Øª
    initSounds();

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
    setupNavigation();
    setupModals();
    setupSearch();
    setupBackup();
    setupOnlineStatus();

    // ØªØ³Ø¬ÙŠÙ„ Service Worker
    registerServiceWorker();

    // Ø±Ø¨Ø· Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    document.getElementById('bookForm').addEventListener('submit', saveBook);
    document.getElementById('studentForm').addEventListener('submit', saveStudent);
    document.getElementById('borrowForm').addEventListener('submit', saveBorrow);

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('addBookBtn').addEventListener('click', () => openBookModal());
    document.getElementById('addStudentBtn').addEventListener('click', () => openStudentModal());
    document.getElementById('newBorrowBtn').addEventListener('click', openBorrowModal);

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    refreshAllViews();

    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Ù…ÙƒØªØ¨ØªÙŠ Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
